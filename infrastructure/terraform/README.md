# Terraform –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞

–≠—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç Terraform –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ Yandex Cloud.

## üìã –ß—Ç–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è

- **–°–µ—Ç—å –∏ –ø–æ–¥—Å–µ—Ç—å** –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞
- **Security Group** —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –¥–ª—è Kubernetes
- **–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã**:
  - 1 Master –Ω–æ–¥–∞ (control plane)
  - 2 Worker –Ω–æ–¥—ã (–¥–ª—è —Ä–∞–±–æ—á–µ–π –Ω–∞–≥—Ä—É–∑–∫–∏)
- **Load Balancer** –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–∏—Å–∞–º
- **Ansible Inventory** –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

```bash
# –°–æ–∑–¥–∞–π—Ç–µ SSH –∫–ª—é—á–∏
ssh-keygen -t rsa -b 4096 -f ~/.ssh/k8s-airflow -N ""

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp terraform.tfvars terraform.tfvars

# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ terraform.tfvars —Å–≤–æ–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
nano terraform.tfvars
```

### 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```bash
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Terraform
terraform init

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
terraform validate

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞–Ω–∞
terraform plan
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```bash
# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
terraform apply

# –ò–ª–∏ –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
terraform apply -auto-approve
```

### 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ outputs
terraform output

# –ü–æ–ª—É—á–∏—Ç—å IP –∞–¥—Ä–µ—Å Load Balancer
terraform output -raw load_balancer_ip

# –ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –¥–ª—è SSH –Ω–∞ master
terraform output -raw ssh_master_command
```

### 5. –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```bash
# –í–ê–ñ–ù–û: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã!
terraform destroy
```

## üí∞ –û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):
- 3 –ø—Ä–µ—Ä—ã–≤–∞–µ–º—ã–µ VM (50% CPU)
- HDD –¥–∏—Å–∫–∏
- **~70-100 —Ä—É–±/–¥–µ–Ω—å**

### Production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- 3+ –Ω–µ–ø—Ä–µ—Ä—ã–≤–∞–µ–º—ã–µ VM (100% CPU)
- SSD –¥–∏—Å–∫–∏
- **~300-500 —Ä—É–±/–¥–µ–Ω—å**

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------------|----------|--------------|
| `yc_cloud_id` | ID –æ–±–ª–∞–∫–∞ –≤ Yandex Cloud | –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `yc_folder_id` | ID –∫–∞—Ç–∞–ª–æ–≥–∞ –≤ Yandex Cloud | –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ |
| `master_count` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ master –Ω–æ–¥ | 1 |
| `worker_count` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ worker –Ω–æ–¥ | 2 |
| `preemptible` | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–µ–º—ã–µ VM | true |
| `core_fraction` | –ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ CPU | 50 |

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
terraform/
‚îú‚îÄ‚îÄ main.tf               # –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ variables.tf          # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ outputs.tf            # –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îú‚îÄ‚îÄ cloud-init.yaml       # –ù–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ VM
‚îú‚îÄ‚îÄ terraform.tfvars.example  # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îî‚îÄ‚îÄ inventory.tpl     # –®–∞–±–ª–æ–Ω –¥–ª—è Ansible
‚îî‚îÄ‚îÄ README.md            # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## üõ†Ô∏è –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
terraform fmt -recursive

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
terraform init -upgrade

# –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
terraform plan -out=tfplan

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∞
terraform apply tfplan

# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
terraform show

# –û–±–Ω–æ–≤–∏—Ç—å outputs
terraform refresh
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **SSH –∫–ª—é—á–∏** –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã –î–û –∑–∞–ø—É—Å–∫–∞ Terraform
2. **S3 bucket** –¥–ª—è state –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
3. **–ü—Ä–µ—Ä—ã–≤–∞–µ–º—ã–µ VM** –º–æ–≥—É—Ç –±—ã—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã Yandex Cloud –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
4. **Security Group** –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫—Ä—ã—Ç–∞ –¥–ª—è –≤—Å–µ—Ö IP (–∏–∑–º–µ–Ω–∏—Ç–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ!)

## üÜò –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ —Å S3 backend
```bash
# –°–æ–∑–¥–∞–π—Ç–µ bucket –≤—Ä—É—á–Ω—É—é
yc storage bucket create --name tfstate-k8s-airflow-unique-name
```

### –û—à–∏–±–∫–∞ —Å SSH –∫–ª—é—á–∞–º–∏
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ –∫–ª—é—á–∞–º
ls -la ~/.ssh/k8s-airflow*

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞
chmod 600 ~/.ssh/k8s-airflow
chmod 644 ~/.ssh/k8s-airflow.pub
```

### –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –∫–≤–æ—Ç
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∑–æ–Ω—É: `ru-central1-b` –∏–ª–∏ `ru-central1-c`
- –£–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Å—É—Ä—Å–æ–≤
- –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∫–≤–æ—Ç