# scripts/operations/emergency-cleanup.sh
#!/bin/bash

set -e
source "$(dirname "${BASH_SOURCE[0]}")/../lib/common.sh"
source "$(dirname "${BASH_SOURCE[0]}")/../lib/validation.sh"

log STEP "ЭКСТРЕННАЯ ОЧИСТКА"
log WARN "Это удалит ВСЕ ресурсы!"

# Подтверждение
echo ""
read -p "Введите 'DESTROY ALL' для подтверждения: " confirm

if [ "$confirm" != "DESTROY ALL" ]; then
    log INFO "Отменено"
    exit 0
fi

log WARN "Начинаю полную очистку..."

# Kubernetes ресурсы
if validate_kubeconfig; then
    log INFO "Удаление Kubernetes namespaces..."
    kubectl delete namespace airflow monitoring argocd ingress-nginx --force --grace-period=0 2>/dev/null || true
fi

# Terraform
if [ -d "${TERRAFORM_DIR}/.terraform" ]; then
    log INFO "Удаление Terraform инфраструктуры..."
    cd "${TERRAFORM_DIR}"

    # Загрузка credentials
    if [ -f "${PROJECT_ROOT}/.env" ]; then
        source "${PROJECT_ROOT}/.env"
        export AWS_ACCESS_KEY_ID="${ACCESS_KEY}"
        export AWS_SECRET_ACCESS_KEY="${SECRET_KEY}"
    fi

    terraform destroy -auto-approve -parallelism=50 || true
fi

log SUCCESS "Экстренная очистка завершена"